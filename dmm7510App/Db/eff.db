########################################################################
# Monitor new ICT data
# Desc: Monitor new data from ICTs and set the new data flag.

# ICT 1 new data flag
record(calc, "$(P)$(R)FlgICT1-Mon"){
  field(ASG, "Reserved")
  field(DESC, "New data flag for ICT1")
  field(INPA, "$(ict-1-prefix)Charge-Mon.VAL CPP")
  field(CALC, "VAL+1")
  field(VAL, "0")
  field(FLNK, "$(P)$(R)ValidData")
}

# ICT 2 new data flag
record(calc, "$(P)$(R)FlgICT2-Mon"){
  field(ASG, "Reserved")
  field(DESC, "New data flag for ICT2")
  field(INPA, "$(ict-2-prefix)Charge-Mon.VAL CPP")
  field(CALC, "VAL+1")
  field(VAL, "0")
  field(FLNK, "$(P)$(R)ValidData")
}

########################################################################
# Validate both ICT measurements
# Desc: Guarantee that both ICTs data is up to date
# before calculating efficiency.

# Efficiency calculation
record(calcout, "$(P)$(R)ValidData"){
  field(ASG, "Reserved")
  field(DESC, "Validate data from ICTs")
  field(INPA, "$(P)$(R)FlgICT1-Mon.VAL")
  field(INPB, "$(P)$(R)FlgICT2-Mon.VAL")
  field(CALC, "(A=1)&&(B=1)")
  field(OOPT, "When Non-zero")
  field(OUT, "$(P)$(R)Eff-Mon.PROC PP")
  field(FLNK, "$(P)$(R)ErrorCalc")
}

# Error calculation
record(calcout, "$(P)$(R)ErrorCalc"){
  field(ASG, "Reserved")
  field(DESC, "Look for errors")
  field(INPA, "$(P)$(R)FlgICT1-Mon.VAL")
  field(INPB, "$(P)$(R)FlgICT2-Mon.VAL")
  field(CALC, "(A-B)#0")
  field(OOPT, "When Non-zero")
  field(OUT, "$(P)$(R)ErrorCnt-Mon.PROC PP")
  field(FLNK, "$(P)$(R)RstFlgs")
}

# Reset flags calc
record(calcout, "$(P)$(R)RstFlgs"){
  field(ASG, "Reserved")
  field(DESC, "Reset new data flags")
  field(INPA, "$(P)$(R)FlgICT1-Mon.VAL")
  field(INPB, "$(P)$(R)FlgICT2-Mon.VAL")
  field(CALC, "((A>0)&&(B>0))||(A>1)||(B>1)")
  field(OOPT, "When Non-zero")
  field(OUT, "$(P)$(R)RstFlgsSeq.PROC PP")
}

# Reset flags seq
record(seq, "$(P)$(R)RstFlgsSeq"){
  field(ASG, "Reserved")
  field(DESC, "Seq to reset new data flags")
  field(SELM, "All")
  field(DO1, "0")
  field(DO2, "0")
  field(LNK1, "$(P)$(R)FlgICT1-Mon")
  field(LNK2, "$(P)$(R)FlgICT1-Mon")
}

# Error count monitor
record(calc, "$(P)$(R)ErrorCnt-Mon"){
  field(ASG, "Reserved")
  field(DESC, "Error count monitor")
  field(INPA, "$(P)$(R)ErrorRst-Cmd.VAL")
  field(CALC, "A=1?0:(VAL+1)")
  field(VAL, "0")
}

# Error counter reset
record(bo, "$(P)$(R)ErrorRst-Cmd"){
  field(ASG, "Reserved")
  field(DESC, "Reset error counter")
  field(ZNAM, "OFF")
  field(ONAM, "ON")
  field(HIGH, "0.5")
  field(OUT, "$(P)$(R)ErrorCnt-Mon.PROC PP")
}

########################################################################
# Efficiency calculation
# Desc: Calculate efficiency and store history.

# Efficiency calculation
record(calcout, "$(P)$(R)Eff-Mon"){
  field(ASG, "Reserved")
  field(DESC, "Efficiency calculation")
  field(INPA, "$(ict-1-prefix)Charge-Mon.VAL CPP")
  field(INPB, "$(ict-2-prefix)Charge-Mon.VAL CPP")
  field(CALC, "(A=0||B=0)?0:(B/A)")
}
